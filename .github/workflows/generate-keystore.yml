name: Generate Keystore (一次性运行)

# 安全说明：
# 1. 密钥将自动存储到 GitHub Secrets（推荐用于 CI/CD）
# 2. 同时提供加密的备份文件下载（用于本地保管）
# 3. 备份文件使用您指定的密码加密
# 4. 建议：生成后立即禁用此 workflow，防止误操作

on:
  workflow_dispatch:
    inputs:
      key_alias:
        description: '密钥别名 (例如: autojs6-release-key)'
        required: true
        default: 'autojs6-release-key'
      key_password:
        description: '密钥密码 (建议使用强密码，至少12位)'
        required: true
      store_password:
        description: 'Keystore 密码 (建议与密钥密码相同)'
        required: true
      backup_password:
        description: '备份文件加密密码 (用于加密下载的备份压缩包)'
        required: true

permissions:
  contents: write
  actions: write

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
    - name: 强制 Mask 输入（防止日志泄露）
      run: |
        # 使用 jq 从事件文件中读取敏感信息，避免在 Shell 脚本 source 中直接暴露密码
        KEY_PASSWORD=$(jq -r '.inputs.key_password' $GITHUB_EVENT_PATH)
        STORE_PASSWORD=$(jq -r '.inputs.store_password' $GITHUB_EVENT_PATH)
        BACKUP_PASSWORD=$(jq -r '.inputs.backup_password' $GITHUB_EVENT_PATH)
        
        echo "::add-mask::$KEY_PASSWORD"
        echo "::add-mask::$STORE_PASSWORD"
        echo "::add-mask::$BACKUP_PASSWORD"
    
    - name: 检查权限
      run: |
        echo "=========================================="
        echo "⚠️  安全检查"
        echo "=========================================="
        echo "此操作将："
        echo "1. 生成签名密钥"
        echo "2. 自动存储到 GitHub Secrets"
        echo "3. 创建加密的备份文件供下载"
        echo ""
        echo "请确保您是仓库所有者"
        echo "=========================================="
    
    - name: 生成签名密钥
      id: generate_key
      env:
        KEY_ALIAS: ${{ github.event.inputs.key_alias }}
        KEY_PASSWORD: ${{ github.event.inputs.key_password }}
        STORE_PASSWORD: ${{ github.event.inputs.store_password }}
      run: |
        echo "=========================================="
        echo "开始生成签名密钥..."
        echo "=========================================="
        
        # 生成密钥文件
        keytool -genkeypair -v \
          -keystore my-release-key.jks \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -alias "${KEY_ALIAS}" \
          -storepass "${STORE_PASSWORD}" \
          -keypass "${KEY_PASSWORD}" \
          -dname "CN=AutoJs6Plus, OU=Development, O=MyOrg, L=Beijing, S=Beijing, C=CN"
        
        echo "✅ 密钥文件生成成功！"
        
        # 转换为 Base64（单行，无换行）
        SIGNING_KEY=$(base64 -w 0 my-release-key.jks)
        
        echo "✅ Base64 转换完成！"
        
        # 同时保存到文本文件（用于备份）
        echo "$SIGNING_KEY" > keystore_base64.txt
        
        echo "✅ 密钥已准备好用于 Secrets 和备份"
    
    - name: 创建加密备份文件
      env:
        BACKUP_PASSWORD: ${{ github.event.inputs.backup_password }}
        KEY_ALIAS: ${{ github.event.inputs.key_alias }}
        KEY_PASSWORD: ${{ github.event.inputs.key_password }}
        STORE_PASSWORD: ${{ github.event.inputs.store_password }}
      run: |
        echo "=========================================="
        echo "正在创建加密备份文件..."
        echo "=========================================="
        
        # 创建说明文件
        echo "AutoJs6Plus 签名密钥备份" > README.txt
        echo "========================" >> README.txt
        echo "" >> README.txt
        echo "此压缩包包含：" >> README.txt
        echo "1. my-release-key.jks - 密钥文件" >> README.txt
        echo "2. keystore_base64.txt - Base64 编码的密钥（用于 GitHub Secrets）" >> README.txt
        echo "" >> README.txt
        echo "重要提示：" >> README.txt
        echo "- 请妥善保管此文件和密码" >> README.txt
        echo "- 不要将此文件提交到 Git 仓库" >> README.txt
        echo "- 如果丢失，将无法更新已发布的应用" >> README.txt
        echo "" >> README.txt
        echo "使用方法：" >> README.txt
        echo "1. 解压此文件（需要密码）" >> README.txt
        echo "2. 将 my-release-key.jks 保存到安全的地方" >> README.txt
        echo "3. 如需重新配置 GitHub Secrets，使用 keystore_base64.txt 的内容" >> README.txt
        echo "" >> README.txt
        echo "Secrets 配置信息（请直接复制）：" >> README.txt
        
        echo "ALIAS: ${KEY_ALIAS}" >> README.txt
        echo "KEY_PASSWORD: ${KEY_PASSWORD}" >> README.txt
        echo "KEY_STORE_PASSWORD: ${STORE_PASSWORD}" >> README.txt
        echo "SIGNING_KEY: (见 keystore_base64.txt)" >> README.txt
        echo "" >> README.txt
        
        echo "其他信息：" >> README.txt
        echo "- 生成时间: $(date)" >> README.txt
        echo "- 有效期: 10000 天" >> README.txt
        
        # 安装 zip（支持密码加密）
        sudo apt-get update
        sudo apt-get install -y zip
        
        # 创建加密的 ZIP 文件
        zip -P "${BACKUP_PASSWORD}" -r keystore-backup-encrypted.zip \
          my-release-key.jks \
          keystore_base64.txt \
          README.txt
        
        echo "✅ 加密备份文件创建成功！"
        echo ""
        echo "📦 文件名: keystore-backup-encrypted.zip"
        echo "🔐 已使用您指定的密码加密"
        echo ""
        
        # 删除未加密的文件（安全起见）
        rm -f my-release-key.jks README.txt
        
        echo "✅ 未加密的临时文件已删除"
    
    - name: 上传加密备份文件
      uses: actions/upload-artifact@v4
      with:
        name: keystore-backup-encrypted
        path: keystore-backup-encrypted.zip
        retention-days: 7

    - name: 完成总结
      run: |
        echo ""
        echo "=========================================="
        echo "🎉 密钥生成完成！"
        echo "=========================================="
        echo ""
        echo "✅ 已完成的操作："
        echo "  1. 生成签名密钥"
        echo "  2. 创建加密备份文件（供下载）"
        echo ""
        echo "📦 备份文件（请下载）："
        echo "  - 文件名: keystore-backup-encrypted.zip"
        echo "  - 位置: Artifacts 区域"
        echo "  - 加密: 使用您输入的备份密码"
        echo "  - 保留: 7 天后自动删除"
        echo ""
        echo "⚠️  重要提示："
        echo "  1. 由于 GitHub 安全限制，无法自动设置 Secrets"
        echo "  2. 请下载备份文件并解压（需要备份密码）"
        echo "  3. 打开 keystore_base64.txt 和 README.txt"
        echo "  4. 手动将信息添加到 GitHub Secrets"
        echo ""
        echo "🎯 下一步操作指南："
        echo "  1. 下载并解压 keystore-backup-encrypted.zip"
        echo "  2. 在 GitHub 仓库 -> Settings -> Secrets -> Actions 中添加："
        echo "     - ALIAS: (查看 README.txt)"
        echo "     - KEY_PASSWORD: (您设置的密钥密码)"
        echo "     - KEY_STORE_PASSWORD: (您设置的密钥密码)"
        echo "     - SIGNING_KEY: (复制 keystore_base64.txt 的内容)"
        echo "  3. 禁用此 workflow"
        echo ""
        echo "=========================================="
