name: Generate Keystore (ä¸€æ¬¡æ€§è¿è¡Œ)

# å®‰å…¨è¯´æ˜ï¼š
# 1. å¯†é’¥å°†è‡ªåŠ¨å­˜å‚¨åˆ° GitHub Secretsï¼ˆæ¨èç”¨äº CI/CDï¼‰
# 2. åŒæ—¶æä¾›åŠ å¯†çš„å¤‡ä»½æ–‡ä»¶ä¸‹è½½ï¼ˆç”¨äºæœ¬åœ°ä¿ç®¡ï¼‰
# 3. å¤‡ä»½æ–‡ä»¶ä½¿ç”¨æ‚¨æŒ‡å®šçš„å¯†ç åŠ å¯†
# 4. å»ºè®®ï¼šç”Ÿæˆåç«‹å³ç¦ç”¨æ­¤ workflowï¼Œé˜²æ­¢è¯¯æ“ä½œ

on:
  workflow_dispatch:
    inputs:
      key_alias:
        description: 'å¯†é’¥åˆ«å (ä¾‹å¦‚: autojs6-release-key)'
        required: true
        default: 'autojs6-release-key'
      key_password:
        description: 'å¯†é’¥å¯†ç  (å»ºè®®ä½¿ç”¨å¼ºå¯†ç ï¼Œè‡³å°‘12ä½)'
        required: true
      store_password:
        description: 'Keystore å¯†ç  (å»ºè®®ä¸å¯†é’¥å¯†ç ç›¸åŒ)'
        required: true
      backup_password:
        description: 'å¤‡ä»½æ–‡ä»¶åŠ å¯†å¯†ç  (ç”¨äºåŠ å¯†ä¸‹è½½çš„å¤‡ä»½å‹ç¼©åŒ…)'
        required: true

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€æŸ¥æƒé™
      run: |
        echo "=========================================="
        echo "âš ï¸  å®‰å…¨æ£€æŸ¥"
        echo "=========================================="
        echo "æ­¤æ“ä½œå°†ï¼š"
        echo "1. ç”Ÿæˆç­¾åå¯†é’¥"
        echo "2. è‡ªåŠ¨å­˜å‚¨åˆ° GitHub Secrets"
        echo "3. åˆ›å»ºåŠ å¯†çš„å¤‡ä»½æ–‡ä»¶ä¾›ä¸‹è½½"
        echo ""
        echo "è¯·ç¡®ä¿æ‚¨æ˜¯ä»“åº“æ‰€æœ‰è€…"
        echo "=========================================="
    
    - name: ç”Ÿæˆç­¾åå¯†é’¥
      id: generate_key
      env:
        KEY_ALIAS: ${{ github.event.inputs.key_alias }}
        KEY_PASSWORD: ${{ github.event.inputs.key_password }}
        STORE_PASSWORD: ${{ github.event.inputs.store_password }}
      run: |
        echo "=========================================="
        echo "å¼€å§‹ç”Ÿæˆç­¾åå¯†é’¥..."
        echo "=========================================="
        
        # ç”Ÿæˆå¯†é’¥æ–‡ä»¶
        keytool -genkeypair -v \
          -keystore my-release-key.jks \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -alias "${KEY_ALIAS}" \
          -storepass "${STORE_PASSWORD}" \
          -keypass "${KEY_PASSWORD}" \
          -dname "CN=AutoJs6Plus, OU=Development, O=MyOrg, L=Beijing, S=Beijing, C=CN"
        
        echo "âœ… å¯†é’¥æ–‡ä»¶ç”ŸæˆæˆåŠŸï¼"
        
        # è½¬æ¢ä¸º Base64ï¼ˆå•è¡Œï¼Œæ— æ¢è¡Œï¼‰
        SIGNING_KEY=$(base64 -w 0 my-release-key.jks)
        
        echo "âœ… Base64 è½¬æ¢å®Œæˆï¼"
        
        # åŒæ—¶ä¿å­˜åˆ°æ–‡æœ¬æ–‡ä»¶ï¼ˆç”¨äºå¤‡ä»½ï¼‰
        echo "$SIGNING_KEY" > keystore_base64.txt
        
        # è¾“å‡ºåˆ° GitHub Actions ç¯å¢ƒå˜é‡ï¼ˆç”¨äºåç»­æ­¥éª¤ï¼‰
        echo "SIGNING_KEY<<EOF" >> $GITHUB_ENV
        echo "$SIGNING_KEY" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        
        echo "âœ… å¯†é’¥å·²å‡†å¤‡å¥½ç”¨äº Secrets å’Œå¤‡ä»½"
    
    - name: åˆ›å»ºåŠ å¯†å¤‡ä»½æ–‡ä»¶
      env:
        BACKUP_PASSWORD: ${{ github.event.inputs.backup_password }}
        KEY_ALIAS: ${{ github.event.inputs.key_alias }}
      run: |
        echo "=========================================="
        echo "æ­£åœ¨åˆ›å»ºåŠ å¯†å¤‡ä»½æ–‡ä»¶..."
        echo "=========================================="
        
        # åˆ›å»ºè¯´æ˜æ–‡ä»¶
        cat > README.txt << 'EOL'
AutoJs6Plus ç­¾åå¯†é’¥å¤‡ä»½
========================

æ­¤å‹ç¼©åŒ…åŒ…å«ï¼š
1. my-release-key.jks - å¯†é’¥æ–‡ä»¶
2. keystore_base64.txt - Base64 ç¼–ç çš„å¯†é’¥ï¼ˆç”¨äº GitHub Secretsï¼‰

é‡è¦æç¤ºï¼š
- è¯·å¦¥å–„ä¿ç®¡æ­¤æ–‡ä»¶å’Œå¯†ç 
- ä¸è¦å°†æ­¤æ–‡ä»¶æäº¤åˆ° Git ä»“åº“
- å¦‚æœä¸¢å¤±ï¼Œå°†æ— æ³•æ›´æ–°å·²å‘å¸ƒçš„åº”ç”¨

ä½¿ç”¨æ–¹æ³•ï¼š
1. è§£å‹æ­¤æ–‡ä»¶ï¼ˆéœ€è¦å¯†ç ï¼‰
2. å°† my-release-key.jks ä¿å­˜åˆ°å®‰å…¨çš„åœ°æ–¹
3. å¦‚éœ€é‡æ–°é…ç½® GitHub Secretsï¼Œä½¿ç”¨ keystore_base64.txt çš„å†…å®¹

å¯†é’¥ä¿¡æ¯ï¼š
EOL
        echo "- åˆ«å: ${KEY_ALIAS}" >> README.txt
        echo "- ç”Ÿæˆæ—¶é—´: $(date)" >> README.txt
        echo "- æœ‰æ•ˆæœŸ: 10000 å¤©" >> README.txt
        
        # å®‰è£… zipï¼ˆæ”¯æŒå¯†ç åŠ å¯†ï¼‰
        sudo apt-get update
        sudo apt-get install -y zip
        
        # åˆ›å»ºåŠ å¯†çš„ ZIP æ–‡ä»¶
        zip -P "${BACKUP_PASSWORD}" -r keystore-backup-encrypted.zip \
          my-release-key.jks \
          keystore_base64.txt \
          README.txt
        
        echo "âœ… åŠ å¯†å¤‡ä»½æ–‡ä»¶åˆ›å»ºæˆåŠŸï¼"
        echo ""
        echo "ğŸ“¦ æ–‡ä»¶å: keystore-backup-encrypted.zip"
        echo "ğŸ” å·²ä½¿ç”¨æ‚¨æŒ‡å®šçš„å¯†ç åŠ å¯†"
        echo ""
        
        # åˆ é™¤æœªåŠ å¯†çš„æ–‡ä»¶ï¼ˆå®‰å…¨èµ·è§ï¼‰
        rm -f my-release-key.jks README.txt
        
        echo "âœ… æœªåŠ å¯†çš„ä¸´æ—¶æ–‡ä»¶å·²åˆ é™¤"
    
    - name: æ·»åŠ åˆ° GitHub Secrets
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        KEY_ALIAS: ${{ github.event.inputs.key_alias }}
        KEY_PASSWORD: ${{ github.event.inputs.key_password }}
        STORE_PASSWORD: ${{ github.event.inputs.store_password }}
      run: |
        echo "=========================================="
        echo "æ­£åœ¨æ·»åŠ  Secrets..."
        echo "=========================================="
        
        # ä½¿ç”¨ GitHub CLI æ·»åŠ  Secrets
        echo "$KEY_ALIAS" | gh secret set ALIAS --repo ${{ github.repository }}
        echo "âœ… ALIAS å·²æ·»åŠ "
        
        echo "$KEY_PASSWORD" | gh secret set KEY_PASSWORD --repo ${{ github.repository }}
        echo "âœ… KEY_PASSWORD å·²æ·»åŠ "
        
        echo "$STORE_PASSWORD" | gh secret set KEY_STORE_PASSWORD --repo ${{ github.repository }}
        echo "âœ… KEY_STORE_PASSWORD å·²æ·»åŠ "
        
        echo "$SIGNING_KEY" | gh secret set SIGNING_KEY --repo ${{ github.repository }}
        echo "âœ… SIGNING_KEY å·²æ·»åŠ "
        
        # åˆ é™¤ Base64 æ–‡æœ¬æ–‡ä»¶ï¼ˆå·²æ·»åŠ åˆ° Secretsï¼‰
        rm -f keystore_base64.txt
        
        echo ""
        echo "=========================================="
        echo "âœ… æ‰€æœ‰ Secrets å·²æˆåŠŸæ·»åŠ ï¼"
        echo "=========================================="
    
    - name: ä¸Šä¼ åŠ å¯†å¤‡ä»½æ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: keystore-backup-encrypted
        path: keystore-backup-encrypted.zip
        retention-days: 7
    
    - name: å®Œæˆæ€»ç»“
      run: |
        echo ""
        echo "=========================================="
        echo "ğŸ‰ å¯†é’¥ç”Ÿæˆå®Œæˆï¼"
        echo "=========================================="
        echo ""
        echo "âœ… å·²å®Œæˆçš„æ“ä½œï¼š"
        echo "  1. ç”Ÿæˆç­¾åå¯†é’¥"
        echo "  2. æ·»åŠ åˆ° GitHub Secretsï¼ˆç”¨äº CI/CDï¼‰"
        echo "  3. åˆ›å»ºåŠ å¯†å¤‡ä»½æ–‡ä»¶ï¼ˆä¾›ä¸‹è½½ï¼‰"
        echo ""
        echo "ğŸ“‹ GitHub Secretsï¼ˆå·²è‡ªåŠ¨æ·»åŠ ï¼‰ï¼š"
        echo "  - ALIAS"
        echo "  - KEY_PASSWORD"
        echo "  - KEY_STORE_PASSWORD"
        echo "  - SIGNING_KEY"
        echo ""
        echo "ğŸ“¦ å¤‡ä»½æ–‡ä»¶ï¼ˆè¯·ä¸‹è½½ï¼‰ï¼š"
        echo "  - æ–‡ä»¶å: keystore-backup-encrypted.zip"
        echo "  - ä½ç½®: Artifacts åŒºåŸŸ"
        echo "  - åŠ å¯†: ä½¿ç”¨æ‚¨è¾“å…¥çš„å¤‡ä»½å¯†ç "
        echo "  - ä¿ç•™: 7 å¤©åè‡ªåŠ¨åˆ é™¤"
        echo ""
        echo "âš ï¸  é‡è¦æç¤ºï¼š"
        echo "  1. ç«‹å³ä¸‹è½½å¤‡ä»½æ–‡ä»¶å¹¶ä¿å­˜åˆ°å®‰å…¨çš„åœ°æ–¹"
        echo "  2. è®°å½•å¤‡ä»½å¯†ç ï¼ˆä½¿ç”¨å¯†ç ç®¡ç†å™¨ï¼‰"
        echo "  3. å»ºè®®ç¦ç”¨æ­¤ workflow é˜²æ­¢è¯¯æ“ä½œ"
        echo "  4. å¤‡ä»½æ–‡ä»¶åŒ…å«å®Œæ•´çš„å¯†é’¥ï¼Œè¯·å¦¥å–„ä¿ç®¡"
        echo ""
        echo "ğŸ¯ ä¸‹ä¸€æ­¥ï¼š"
        echo "  1. ä¸‹è½½ Artifacts ä¸­çš„ keystore-backup-encrypted.zip"
        echo "  2. ä½¿ç”¨å¤‡ä»½å¯†ç è§£å‹"
        echo "  3. å°†æ–‡ä»¶ä¿å­˜åˆ°å®‰å…¨çš„åœ°æ–¹ï¼ˆåŠ å¯†äº‘ç›˜ã€å¯†ç ç®¡ç†å™¨ç­‰ï¼‰"
        echo "  4. ç¦ç”¨æ­¤ workflowï¼ˆActions â†’ ... â†’ Disable workflowï¼‰"
        echo "  5. å¼€å§‹ä½¿ç”¨ Android CI ç¼–è¯‘ç­¾åçš„ APK"
        echo ""
        echo "=========================================="
